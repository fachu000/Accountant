

# Important information:
# 
# The format of calendar files specifies time in terms of UTC, which
# in winter is one hour less than the central european time.
#
# Events that span the entire day ("all day") or multiple entire days
# do not have a field of the form "DTSTART:19700329T020000"; instead,
# they have a field of the form
# "DTSTART;VALUE=DATE:20170906". (similar for DTEND)
#


def dictionaryFromListOfStrings(l_Node):
    """Returns a dictionary corresponding to the event with fields specified by the list of strings l_Node"""
    d_node = {};
    for str in l_Node:
        indColon = str.find(':')        
        d_node[str[0:indColon]] = str[indColon+1:len(str)-1]
    return d_node


########################################################################

def readNodeList():

    f = open('caltest.txt','r')
    #    f = open('calfull.txt','r')

    ld_nodes = [];

    for myline in f:
        if myline=='BEGIN:VEVENT\n':
            l_thisNode = [];
            break

    for myline in f:
        if myline=='BEGIN:VEVENT\n':
            l_thisNode = [];
        elif myline=='END:VEVENT\n':
            ld_nodes.append(dictionaryFromListOfStrings(l_thisNode))
        else:
            l_thisNode.append(myline)

    f.close()

    return ld_nodes


########################################################################

def splitAtMidnight(ld_nodes_in):
    """If an event starts one day and ends the following day, then it is split into two events, the first ends at UTC 00:00 and the second starts at UTC 00:00. Moreover, the output list does not contain *all day* events"""  
    
    ld_nodes_out = []
    for node in ld_nodes_in:
        if 'DTSTART' in node:
            str_start = node['DTSTART']
            str_dtstart = str_start[0:8]
            str_end = node['DTEND']
            str_dtend = str_end[0:8]
            if str_dtend == str_dtstart:
                ld_nodes_out.append(node)
            else:
                print('splitting')
                node1 = copy.copy(node)
                node1['DTEND'] = str_dtend + 'T000000Z'
                node2 = copy.copy(node)
                node2['DTSTART'] = str_dtend + 'T000000Z'
                ld_nodes_out.append(node1)
                ld_nodes_out.append(node2)

    return ld_nodes_out

########################################################################

def dictByDates(ld_nodes):
    """Creates a dictionary where each field name is a date and the contents of that field is a list of events ocurring on that date."""
    d_nodes = {};
    for node in ld_nodes:
        if 'DTSTART' in node:
            str_start = node['DTSTART']
            str_dtstart = str_start[0:8]            
            if str_dtstart not in d_nodes:
                d_nodes[str_dtstart] = [];
            d_nodes[str_dtstart].append(node)

    return d_nodes


########################################################################

def date_range(start_date, end_date):
    for ordinal in range(start_date.toordinal(), end_date.toordinal()):
        yield datetime.date.fromordinal(ordinal)

########################################################################

import copy

print('Read calendar v1.0')
ld_nodes = readNodeList()

ld_nodes = splitAtMidnight(ld_nodes)

d_nodes = dictByDates(ld_nodes)

for date in list(d_nodes.keys()):
    print(date,' ',len(d_nodes[date]))




quit()



# how to iterate over dates

import datetime
from datetime import timedelta, date

start_date = date(2018, 1, 1)
end_date = date(2018, 2, 15)
for single_date in date_range(start_date, end_date):
    print(single_date.strftime("%Y-%m-%d"))


